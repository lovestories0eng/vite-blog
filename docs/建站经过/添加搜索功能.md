---
# layout: home
# # é¦–é¡µéƒ¨åˆ†å…ƒç´ å®šåˆ¶
# blog:
#  name: '@sugarat/theme'
#  motto: ç®€çº¦é£çš„ Vitepress åšå®¢ä¸»é¢˜
#  inspiring: åŸºäº Vitepress å®šåˆ¶çš„ä¸»é¢˜ğŸ¨
#  pageSize: 6
---

## èµ·å› 
`Vue`çš„å®˜æ–¹æ–‡æ¡£ä»¥åŠå¾ˆå¤šåšå®¢éƒ½æ”¯æŒæœç´¢åŠŸèƒ½ï¼Œè™½ç„¶`agolia`çš„æœç´¢åŠŸèƒ½å¾ˆå¥½ï¼Œä½†æ˜¯æˆ‘æƒ³è¦è‡ªå·±å¼€å‘ä¸€ä¸ªï¼Œè¿™é‡Œå¾ˆå¤§ç¨‹åº¦ä¸Šå€Ÿé‰´äº†å¦å¤–ä¸€ä¸ªå¤§ä½¬ï¼ˆhttps://github.com/ATQQ/sugar-blog/tree/master/packages/themeï¼‰ã€‚
ç”±äºä½œè€…é‡‡ç”¨`MIT Lincense`ï¼Œå› æ­¤å¯ä»¥å¯¹å…¶è¿›è¡Œä¿®æ”¹å’Œä¼ æ’­ã€‚

## è¯»å–æ–‡æ¡£å…ƒæ•°æ®
åœ¨æ­¤ä¹‹å‰éœ€è¦å¯¼å…¥å‡ ä¸ªæ¨¡å—ä»¥å‡è½»æˆ‘ä»¬çš„å·¥ä½œé‡ã€‚
```TypeScript
import glob from 'fast-glob'
import matter from 'gray-matter'
import fs from 'fs'
import path from 'path'
import { formatDate } from './utils/index'
```

æœç´¢åŠŸèƒ½è‚¯å®šéœ€è¦è¯»å–æ‰€æœ‰çš„`.md`æ–‡æ¡£ï¼Œå› æ­¤éœ€è¦è¯»å–æ–‡æ¡£çš„å…ƒæ•°æ®
```TypeScript
export function getThemeConfig(cfg?: Partial<Theme.BlogConfig>) {
  // process.argv
  /* 
  [
    '/Users/panshihuang/.nvm/versions/node/v16.15.1/bin/node',
    '/Users/panshihuang/node_modules/.bin/vitepress',
    'dev',
    'docs',
    '--config',
    'tsconfig.json'
  ]
  */
  const srcDir = cfg?.srcDir || process.argv.slice(2)?.[1] || '.'
  // è·å–æ‰€æœ‰çš„.mdæ–‡æ¡£
  const files = glob.sync(`${srcDir}/**/*.md`, { ignore: ['node_modules'] })

  const data = files
    .map((v) => {
      // å¤„ç†æ–‡ä»¶åç¼€å
      let route = v.replace('.md', '')
      // å»é™¤ srcDir å¤„ç†ç›®å½•å
      // å¦‚ï¼š'docs/ç®—æ³•ä¸æ•°æ®ç»“æ„/ACM/ACM-ç¬¬äºŒæ¬¡æµ‹è¯•' æ›¿æ¢æˆ 'ç®—æ³•ä¸æ•°æ®ç»“æ„/ACM/ACM-ç¬¬äºŒæ¬¡æµ‹è¯•'
      if (route.startsWith('./')) {
        route = route.replace(
          new RegExp(
            // æ­£åˆ™è¡¨è¾¾å¼ ^\\.\\/ åŒ¹é…ä»¥å½“å‰ç›®å½•ï¼ˆå³"./"ï¼‰å¼€å¤´çš„å­—ç¬¦ä¸²
            `^\\.\\/
              ${path // è°ƒç”¨pathæ¨¡å—
              // å½“å‰è·¯å¾„åé¢åŠ ä¸Š"/"
              .join(srcDir, '/')
              // path.sep = '/'
              .replace(new RegExp(`\\${path.sep}`, 'g'), '/')
            }`
          ),
          ''
        )
      } else {
        route = route.replace(
          new RegExp(
            `^${path
              .join(srcDir, '/')
              .replace(new RegExp(`\\${path.sep}`, 'g'), '/')}`
          ),
          ''
        )
      }

      const fileContent = fs.readFileSync(v, 'utf-8')
      // TODO: æ”¯æŒJSON
      // è¯»å–æ–‡æ¡£çš„å‰ç½®å†…å®¹ http://www.npmdoc.org/gray-matterzhongwenwendanggray-matter-jszhongwenjiaochengjiexi.html
      const meta: Partial<Theme.PageMeta> = {
        ...matter(fileContent).data
      }
      if (!meta.title) {
        meta.title = getDefaultTitle(fileContent)
      }
      if (!meta.date) {
        // getGitTimestamp(v).then((v) => {
        //   meta.date = formatDate(v)
        // })
        meta.date = getFileBirthTime(v)
      } else {
        // TODO: å¼€æ”¾é…ç½®ï¼Œè®¾ç½®æ—¶åŒº
        meta.date = formatDate(
          new Date(`${new Date(meta.date).toUTCString()}+8`)
        )
      }

      // å¤„ç†tagså’Œcategories,å…¼å®¹å†å²æ–‡ç« 
      meta.tag = (meta.tag || []).concat([
        ...new Set([...(meta.categories || []), ...(meta.tags || [])])
      ])

      // è·å–æ‘˜è¦ä¿¡æ¯
      const wordCount = 100
      meta.description =
        meta.description || getTextSummary(fileContent, wordCount)

      // è·å–å°é¢å›¾
      meta.cover =
        meta.cover ||
        fileContent.match(/[!]\[.*?\]\((https:\/\/.+)\)/)?.[1] ||
        ''
      return {
        route: `/${route}`,
        meta
      }
    })
    .filter((v) => v.meta.layout !== 'home')

  return {
    blog: {
      pagesData: data as Theme.PageData[],
      ...cfg
    },
    sidebar: [
      {
        text: '',
        items: []
      }
    ]
  }
}
```
## è¾…åŠ©å‡½æ•°
Function clearMatterContent

ç”¨å¤„ï¼šå»é™¤`.md`æ–‡æ¡£ä¹‹å‰çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚
```TypeScript
export function clearMatterContent(content: string) {
  let first___: unknown
  let second___: unknown

  const lines = content.split('\n').reduce<string[]>((pre, line) => {
    // ç§»é™¤å¼€å¤´çš„ç©ºç™½è¡Œ
    if (!line.trim() && pre.length === 0) {
      return pre
    }
    if (line.trim() === '---') {
      if (first___ === undefined) {
        first___ = pre.length
      } else if (second___ === undefined) {
        second___ = pre.length
      }
    }
    pre.push(line)
    return pre
  }, [])
  return (
    lines
      // å‰”é™¤---ä¹‹é—´çš„å†…å®¹
      .slice((second___ as number) || 0)
      .join('\n')
  )
}
```

Function getDefaultTitle

ç”¨å¤„ï¼šè·å–æ–‡æ¡£çš„é»˜è®¤æ ‡é¢˜
```TypeScript
export function getDefaultTitle(content: string) {
  const title =
    clearMatterContent(content)
      .split('\n')
      ?.find((str) => {
        return str.startsWith('# ')
      })
      ?.slice(2)
      .replace(/[\s]/g, '') || ''
  return title
}
```

Function getFileBirthTime

ç”¨å¤„ï¼šå¦‚æœæ–‡æ¡£çš„å…ƒæ•°æ®æ²¡æœ‰æŒ‡å®šæ–‡ä»¶æ—¥æœŸï¼Œåˆ™é»˜è®¤ä¸Šæ–‡æ¡£çš„åˆ›å»ºæ—¥æœŸ

```TypeScript
export function getFileBirthTime(url: string) {
  let date = new Date()

  try {
    // å‚è€ƒ vitepress ä¸­çš„ getGitTimestamp å®ç°
    const infoStr = execSync(`git log -1 --pretty="%ci" ${url}`)
      .toString('utf-8')
      .trim()
    if (infoStr) {
      date = new Date(infoStr)
    }
  } catch (error) {
    return formatDate(date)
  }

  return formatDate(date)
}
```
Function getTextSummary

ç”¨å¤„ï¼šé™¤å»éå¿…è¦çš„ä¿¡æ¯ä¹‹åï¼Œè‡ªåŠ¨è¯»å–æ–‡æ¡£å‰é¢çš„æ•°æ®å½“ä½œ`summary`

```TypeScript
function getTextSummary(text: string, count = 100) {
  return (
    clearMatterContent(text)
      .match(/^# ([\s\S]+)/m)?.[1]
      // é™¤å»æ ‡é¢˜
      ?.replace(/#/g, '')
      // é™¤å»å›¾ç‰‡
      ?.replace(/!\[.*?\]\(.*?\)/g, '')
      // é™¤å»é“¾æ¥
      ?.replace(/\[(.*?)\]\(.*?\)/g, '$1')
      // é™¤å»åŠ ç²—
      ?.replace(/\*\*(.*?)\*\*/g, '$1')
      ?.split('\n')
      ?.filter((v) => !!v)
      ?.slice(1)
      ?.join('\n')
      ?.replace(/>(.*)/, '')
      ?.slice(0, count)
  )
}
```
Function defineConfig

ç”¨å¤„ï¼šæ‹“å±•é…ç½®ï¼Œæ·»åŠ `pagefind`æ’ä»¶ä½œä¸ºä¸€ç§å¯é€‰é¡¹
* ç”Ÿäº§æ¨¡å¼ï¼š`pagefind`çš„æœç´¢åŠŸèƒ½
* å¼€å‘æ¨¡å¼ï¼šè‡ªå®šä¹‰æœç´¢

```TypeScript
export function defineConfig(config: UserConfig<Theme.Config>) {
  if (config?.themeConfig?.blog?.search === 'pagefind') {
    let flag = true
    let originLog: any = null
    config.vite = {
      ...config.vite,
      plugins: [
        ...(config.vite?.plugins || []),
        {
          name: 'vitepress-plugin-pagefind',
          // è¿™ä¸ªé’©å­åªä¼šåœ¨ç”Ÿäº§ç¯å¢ƒè¢«è°ƒç”¨, è°ƒç”¨æ—¶æœºæ˜¯ç”Ÿæˆä»£ç ä¹‹å‰.
          buildEnd() {
            const { log } = console
            // TODO: hack
            if (flag) {
              flag = false
              originLog = log
              Object.defineProperty(console, 'log', {
                value() {
                  if (`${arguments[0]}`.includes('build complete')) {
                    console.log = originLog
                    setTimeout(() => {
                      originLog()
                      originLog('=== pagefind: https://pagefind.app/ ===')
                      const command = `npx pagefind --source ${path.join(
                        process.argv.slice(2)?.[1] || '.',
                        '.vitepress/dist'
                      )}`
                      originLog(command)
                      originLog()
                      execSync(command, {
                        stdio: 'inherit'
                      })
                    }, 100)
                  }
                  return log.apply(this, arguments)
                }
              })
            }
          },
        }
      ]
    }
  }
  return config
}
```

## TSç±»å‹è§„å®š
é€šè¿‡ç±»å‹è§„å®šä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨å¼€å‘ä¸­ä½¿ç”¨`IDE`çš„ä»£ç æç¤ºã€‚
```TypeScript
import { DefaultTheme, UserConfig } from 'vitepress';

declare namespace Theme {
  interface PageMeta {
    title: string;
    date: string;
    tag?: string[];
    description?: string;
    cover?: string;
    sticky?: number;
    author?: string;
    hidden?: boolean;
    layout?: string;
    categories: string[];
    tags: string[];
  }
  interface PageData {
    route: string;
    meta: PageMeta;
  }
  interface BlogConfig {
    blog?: false;
    pagesData: PageData[];
    srcDir?: string;
    author?: string;
    search?: boolean | 'pagefind';
  }
  interface Config extends DefaultTheme.Config {
    blog: BlogConfig;
  }
  interface HomeConfig {
    handleChangeSlogan?: (oldSlogan: string) => string | Promise<string>;
  }
}

declare function getThemeConfig(cfg?: Partial<Theme.BlogConfig>): {
  blog: {
    blog?: false | undefined;
    pagesData: Theme.PageData[];
    srcDir?: string | undefined;
    author?: string | undefined;
    search?: boolean | "pagefind" | undefined;
  };
  sidebar: {
    text: string;
    items: never[];
  }[];
};
declare function getDefaultTitle(content: string): string;
declare function clearMatterContent(content: string): string;
declare function getFileBirthTime(url: string): string;
declare function getGitTimestamp(file: string): Promise<unknown>;
declare function defineConfig(config: UserConfig<Theme.Config>): UserConfig<Theme.Config>;

export { clearMatterContent, defineConfig, getDefaultTitle, getFileBirthTime, getGitTimestamp, getThemeConfig };

```

## ç»„ä»¶å¼€å‘
å…·ä½“å¦‚ä½•å®ç°çš„ï¼Œå¯ä»¥çœ‹çœ‹`github`ä»“åº“æºä»£ç 
```TypeScript
<template>
  <div class="blog-search" data-pagefind-ignore="all">
    <div class="nav-search-btn-wait" @click="searchModal = true">
      <svg width="14" height="14" viewBox="0 0 20 20">
        <path
          d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z"
          stroke="currentColor"
          fill="none"
          fill-rule="evenodd"
          stroke-linecap="round"
          stroke-linejoin="round"
        ></path>
      </svg>
      <span v-if="!isMinimized" class="search-tip">{{
        'Search'
      }}</span>
      <span v-if="!isMinimized" class="metaKey"> {{ metaKey }} K </span>
    </div>
    <Command.Dialog :visible="searchModal" theme="algolia">
      <template #header>
        <Command.Input
          v-model:value="searchWords"
          :placeholder="'Search Docs'"
        />
      </template>
      <template #body>
        <div class="search-dialog">
          <Command.List>
            <Command.Empty v-if="!searchResult.length">
              {{ 'No results found.' }}
            </Command.Empty>
            <Command.Group v-else :heading="headingText">
              <Command.Item
                v-for="item in showSearchResult"
                :data-value="withBase(item.route)"
                :key="item.route"
                @select="handleSelect"
              >
                <div class="link">
                  <div class="title">
                    <span>{{ item.meta.title }}</span>
                    <span class="date">
                      {{ formatDate(item.meta.date, 'yyyy-MM-dd') }}</span
                    >
                  </div>
                  <div class="des" v-html="item.meta.description"></div>
                </div>
              </Command.Item>
            </Command.Group>
          </Command.List>
        </div>
      </template>
      <template #footer v-if="searchResult.length">
        <div class="command-palette-logo">
          <a
            href="https://github.com/cloudcannon/pagefind"
            target="_blank"
            rel="noopener noreferrer"
          >
            <span class="command-palette-Label">Search by</span>
            <logo-pagefind style="width: 77px" />
          </a>
        </div>
        <ul class="command-palette-commands">
          <li>
            <kbd class="command-palette-commands-key"
              ><svg width="15" height="15" aria-label="Enter key" role="img">
                <g
                  fill="none"
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.2"
                >
                  <path
                    d="M12 3.53088v3c0 1-1 2-2 2H4M7 11.53088l-3-3 3-3"
                  ></path>
                </g></svg></kbd
            ><span class="command-palette-Label">to select</span>
          </li>
          <li>
            <kbd class="command-palette-commands-key"
              ><svg width="15" height="15" aria-label="Arrow down" role="img">
                <g
                  fill="none"
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.2"
                >
                  <path d="M7.5 3.5v8M10.5 8.5l-3 3-3-3"></path>
                </g></svg></kbd
            ><kbd class="command-palette-commands-key"
              ><svg width="15" height="15" aria-label="Arrow up" role="img">
                <g
                  fill="none"
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.2"
                >
                  <path d="M7.5 11.5v-8M10.5 6.5l-3-3-3 3"></path>
                </g></svg></kbd
            ><span class="command-palette-Label">to navigate</span>
          </li>
          <li>
            <kbd class="command-palette-commands-key"
              ><svg width="15" height="15" aria-label="Escape key" role="img">
                <g
                  fill="none"
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.2"
                >
                  <path
                    d="M13.6167 8.936c-.1065.3583-.6883.962-1.4875.962-.7993 0-1.653-.9165-1.653-2.1258v-.5678c0-1.2548.7896-2.1016 1.653-2.1016.8634 0 1.3601.4778 1.4875 1.0724M9 6c-.1352-.4735-.7506-.9219-1.46-.8972-.7092.0246-1.344.57-1.344 1.2166s.4198.8812 1.3445.9805C8.465 7.3992 8.968 7.9337 9 8.5c.032.5663-.454 1.398-1.4595 1.398C6.6593 9.898 6 9 5.963 8.4851m-1.4748.5368c-.2635.5941-.8099.876-1.5443.876s-1.7073-.6248-1.7073-2.204v-.4603c0-1.0416.721-2.131 1.7073-2.131.9864 0 1.6425 1.031 1.5443 2.2492h-2.956"
                  ></path>
                </g></svg></kbd
            ><span class="command-palette-Label">to close</span>
          </li>
        </ul>
      </template>
    </Command.Dialog>
  </div>
</template>
<script lang="ts" setup>
// @ts-nocheck
import { computed, nextTick, ref, watch, onBeforeMount, onMounted } from 'vue'
import { Command } from 'vue-command-palette'
import { useRoute, useRouter, withBase } from 'vitepress'
import { useMagicKeys, useWindowSize } from '@vueuse/core'
import { useArticles } from '../composables/config/blog'
import { formatDate } from '../utils'
import LogoPagefind from './LogoPagefind.vue'

const windowSize = useWindowSize()

const docs = useArticles()

const isMinimized = computed(() => windowSize.width.value < 760)
const flexValue = computed(() => (isMinimized.value ? 0 : 1))

const headingText = computed(() => {
  return `Total: ${searchResult.value.length} search results.`
})

const addInlineScript = () => {
  // ä½¿ç”¨scriptæ ‡ç­¾å¼•å…¥ pagefind.js ä¾èµ–
  const scriptText = `import('/_pagefind/pagefind.js')
        .then((module) => {
          window.__pagefind__ = module
        })
        .catch(() => {
          console.log('not load /_pagefind/pagefind.js')
        })`
  const inlineScript = document.createElement('script')
  inlineScript.innerHTML = scriptText
  document.head.appendChild(inlineScript)
}

onBeforeMount(() => {
  addInlineScript()
})

const metaKey = ref('')
onMounted(() => {
  metaKey.value = /(Mac|iPhone|iPod|iPad)/i.test(navigator?.platform)
    ? 'âŒ˜'
    : 'Ctrl'
})
const searchModal = ref(false)
const searchWords = ref('')

const keys = useMagicKeys()
const CmdK = keys['Meta+K']
// eslint-disable-next-line dot-notation, prefer-destructuring
const Escape = keys['Escape']

watch(CmdK, (v) => {
  if (v) {
    searchModal.value = true
  }
})
watch(Escape, (v) => {
  if (v) {
    searchModal.value = false
  }
})

const searchResult = ref<any[]>([])
const inlineSearch = () => {
  if (!searchWords.value) {
    searchResult.value = []
    return
  }
  searchResult.value = docs.value
    .filter((v) =>
      `${v.meta.description}${v.meta.title}`.includes(searchWords.value)
    )
    .map((v) => {
      return {
        ...v,
        meta: {
          ...v.meta,
          description:
            v.meta?.description?.replace(
              new RegExp(`(${searchWords.value})`, 'g'),
              '<mark>$1</mark>'
            ) || ''
        }
      }
    })
  searchResult.value.sort((a, b) => {
    return +new Date(b.meta.date) - +new Date(a.meta.date)
  })
}

watch(
  () => searchWords.value,
  async () => {
    // dev-serverå…œåº•
    if (!window?.__pagefind__?.search) {
      inlineSearch()
    } else {
      await window?.__pagefind__
        ?.search?.(searchWords.value)
        .then(async (search: any) => {
          const result = await Promise.all(
            search.results.map((v: any) => v.data())
          )
          searchResult.value = []
          docs.value.forEach((v) => {
            const match = result.find((r) => r.url.startsWith(v.route))
            if (match) {
              searchResult.value.push({
                ...v,
                meta: {
                  ...v.meta,
                  description: match.excerpt
                }
              })
            }
          })
        })
    }
    nextTick(() => {
      // hack åŸç»„ä»¶å®ç°
      document.querySelectorAll('div[aria-disabled="true"]').forEach((v) => {
        v.setAttribute('aria-disabled', 'false')
      })
    })
  }
)

const handleClickMask = (e: any) => {
  if (e.target === e.currentTarget) {
    searchModal.value = false
  }
}
watch(
  () => searchModal.value,
  (newValue) => {
    if (newValue) {
      nextTick(() => {
        document
          .querySelector('div[command-dialog-mask]')
          ?.addEventListener('click', handleClickMask)
      })
    } else {
      document
        .querySelector('div[command-dialog-mask]')
        ?.removeEventListener('click', handleClickMask)
    }
  }
)
// TODOï¼šæœç´¢ç»“æœé™åˆ¶
const pageSize = ref(999)
const currentPage = ref(0)
const showSearchResult = computed(() => {
  // åˆæ³•æ€§å¤„ç†
  const pageIdx =
    currentPage.value % Math.ceil(searchResult.value.length / pageSize.value)
  const startIdx = pageIdx * pageSize.value
  return searchResult.value.slice(startIdx, startIdx + pageSize.value)
})

const router = useRouter()
const route = useRoute()
const handleSelect = (target: any) => {
  searchModal.value = false
  if (!route.path.startsWith(target.value)) {
    // searchWords.value = ''
    router.go(target.value)
  }
}
</script>

<style lang="css" scoped>
.blog-search {
  flex: v-bind(flexValue);
  display: flex;
  padding-left: 32px;
}
.blog-search .nav-search-btn-wait {
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 6px;
  box-sizing: border-box;
}
.blog-search .nav-search-btn-wait .metaKey {
  margin-left: 10px;
  font-size: 12px;
}
.blog-search .nav-search-btn-wait:hover {
  border: 1px solid var(--vp-c-brand);
  border-radius: 6px;
}
.blog-search .nav-search-btn-wait .search-tip {
  color: #909399;
  font-size: 12px;
  padding-left: 10px;
}
</style>

<style lang="css">
@import './search.css';
</style>

```

## æ›¿æ¢åŸç”Ÿæœç´¢ç»„ä»¶
```TypeScript
<!--.vitepress/theme/MyLayout.vue-->
<script setup>
import Search from './components/Search.vue'
import DefaultTheme from 'vitepress/theme'

const { Layout } = DefaultTheme
</script>

<template>
  <Layout>
    <!-- è‡ªå®šä¹‰æœç´¢ -->
    <template #nav-bar-content-before>
        <Search />
    </template>
  </Layout>
</template>

```

## ä½¿ç”¨æ–°ä¸»é¢˜
```TypeScript
import { Theme } from 'vitepress'
import DefaultTheme from 'vitepress/theme'
import CustomLayout from './CustomLayout.vue'

// override style
import './styles/index.scss'

// element-ui
import 'element-plus/dist/index.css'
import 'element-plus/theme-chalk/dark/css-vars.css'

import { withConfigProvider } from './composables/config/blog'

export const BlogTheme: Theme = {
    ...DefaultTheme,
    Layout: withConfigProvider(CustomLayout)
}

export * from './composables/config/index'
export default BlogTheme
```